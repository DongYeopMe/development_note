# ê°œìš”

ìš°ë¦¬ê°€ ëŒ“ê¸€ì´ë‚˜ ì¢‹ì•„ìš” ê°™ì€ ê¸°ëŠ¥ë“¤ì„ ì»ì„ë•Œ ìš”ì²­ ì—†ì´ë„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì„œë²„ ë³€ê²½ì‚¬í•­ì„ ì›¹ ë¸Œë¼ìš°ì €ì— ë³´ë‚´ì¤˜ì•¼í•˜ëŠ” ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. í•˜ì§€ë§Œ Cient-Server ëª¨ë¸ì˜ HTTP í†µì‹ ìœ¼ë¡œëŠ” ì´ëŸ° ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê¸°ë„ ì–´ë µê³ , í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì´ ìˆì–´ì•¼ ì„œë²„ê°€ ì‘ë‹µì„ í• ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ë‹¤.

ê·¸ë˜ì„œ ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ í†µì‹ ì„ í•´ì•¼í• ì§€ ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤.

# ì‹¤ì‹œê°„ í†µì‹  ë°©ë²•

## Web Socket

![image](https://github.com/DongYeopMe/development_note/assets/70151275/ee770ee8-aeb8-4cd8-955d-ea58cf8254da)

ì›¹ì†Œì¼“ì€ HTML5 í‘œì¤€ ê¸°ìˆ ë¡œ, HTTP í™˜ê²½ì—ì„œ í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ì‚¬ì´ì— í•˜ë‚˜ì˜  TCP ì—°ê²°ì„ í†µí•´ ì‹¤ì‹œê°„ìœ¼ë¡œ ì „ì´ì¤‘ í†µì‹ ì„ ê°€ëŠ¥í•˜ê²Œ í•˜ëŠ” í”„ë¡œí† ì½œì´ë‹¤.

HTTP í†µì‹ ì—ì„œëŠ” ì—°ê²°ì„ ì§€ì†í•˜ì§€ ì•Šê³ , í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ë¡œ ë‹¨ë°©í–¥ ìš”ì²­ë§Œ ê°€ëŠ¥í•˜ê²Œ êµ¬ì„±ë˜ì–´ìˆëŠ”ë°,

ì´ê²ƒì´ ë“±ì¥í•œ ì´í›„ëŠ” í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ê°„ì˜ ì‹¤ì‹œê°„ í†µì‹ ì´ ê°€ëŠ¥í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.

ê·¸ë˜ì„œ í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ê°„ ì—°ê²°ì„ ì§€ì†ì ìœ¼ë¡œ ìœ ì§€í•˜ê³  ì„œë²„â†’ í´ë¼ì´ì–¸íŠ¸ë¡œ, í´ë¼ì´ì–¸íŠ¸â†’ì„œë²„ë¡œ ë°ì´í„°ë¥¼ ë³´ë‚¼ìˆ˜ ìˆê²Œ ë¨ìœ¼ë¡œ ì–‘ë°©í–¥ í†µì‹ ì„ í• ìˆ˜ ìˆë‹¤.

ì„œë¹„ìŠ¤ : ê²Œì„,ì±„íŒ… ë“±ë“±(ì‹¤ì‹œê°„ì„±!)

<aside>
ğŸ’¡ ì°¸ê³ ë¡œ ì›¹ì†Œì¼“ì€ ìš”ì²­ê³¼ ì‘ë‹µ ê°œë…ì´ ì•„ë‹Œ ì„œë¡œ ë°ì´í„°ë¥¼ ì£¼ê³  ë°›ëŠ” ë°©ì‹.

</aside>

## HTTP

ì‚¬ì‹¤ HTTP ë°©ì‹ë„ ì‹¤ì‹œê°„ì„±ì„ ë³´ì¥í•˜ëŠ” ê¸°ë²•ì´ ì¡´ì¬í•œë‹¤.

HTTP ì™€ê°™ì€ ë‹¨ë°©í–¥ í”„ë¡œí† ì½œë¡œ ì œí•œëœ ì›¹ í™˜ê²½ì—ì„œ ì›¹ ë¸Œë¼ìš°ì €ì™€ ì„œë²„ ì‚¬ì´ì˜ ì–‘ë°©í–¥ ì‹¤ì‹œê°„ í†µì‹ ì„ ìœ„í•œ ë‹¤ì–‘í•œ ê¸°ë²•ë“¤ì´ ì¡´ì¬í•œë‹¤.

ì¢…ë¥˜ëŠ” Polling,Long Polling, Streaming

### HTTP Polling

![image](https://github.com/DongYeopMe/development_note/assets/70151275/4402e668-4423-4b46-a2ea-d14b7d1428af)

Pollingì€ ì›¹ ë¸Œë¼ìš°ì €ê°€ ì£¼ê¸°ì ìœ¼ë¡œ ì„œë²„ì—ê²Œ ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë°©ì‹ì´ë‹¤.

ë§Œì¼ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ì§€ ì•Šì•˜ë‹¤ë©´ Responseì—” ì´ë²¤íŠ¸ ì •ë³´ê°€ í¬í•¨ë˜ì§€ ì•Šê³ , ë°˜ëŒ€ë¡œ ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆë‹¤ë©´ í¬í•¨ë˜ëŠ” ë°©ì‹ì´ë‹¤.

ì£¼ê¸°ì ìœ¼ë¡œ ì„œë²„ì—ê²Œ ì´ë²¤íŠ¸ ë°œìƒì—¬ë¶€ë¥¼ í™•ì¸í•˜ê¸°ì— ì‹¤ì‹œê°„ì„±ì´ ë–¨ì–´ì§€ë©°, ì£¼ê¸°ì ìœ¼ë¡œ ìš”ì²­/ì‘ë‹µì´ ì˜¤ê°€ì„œ ê³„ì† íŠ¸ë˜í”½ì´ ë°œìƒí•˜ì—¬ ì„œë²„ì— ë¶€ë‹´ì¤€ë‹¤.

ì •ë¦¬í•˜ë©´

- í´ë¼ì´ì–¸íŠ¸ê°€ ì¼ì • ì£¼ê¸°ë¡œ ì„œë²„ì—ê²Œ í•„ìš”í•œ ë°ì´í„°ë¥¼ ìš”ì²­ë° ì‘ë‹µí•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.
- ê°€ì¥ ì‰¬ìš´ ë°©ì‹ì´ì§€ë§Œ, ì„œë²„ì— ë¶€ë‹´ì„ ì£¼ê²Œ ë©ë‹ˆë‹¤.

### Long Polling

![image](https://github.com/DongYeopMe/development_note/assets/70151275/3ca72c28-2ae9-4a56-8c61-9d7bb353ab08)

Long Pollingì€ ê¸°ì¡´ Pollingì˜ ì‹¤ì‹œê°„ì„±ì„ ë³´ì™„í•œ ê¸°ë²•ì´ë‹¤. ì›¹ ë¸Œë¼ìš°ì €ê°€ ìš”ì²­ì„ ì „ì†¡í• ë•Œ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ê¸° ì „ê¹Œì§€ëŠ” Responseë¥¼ ë³´ë‚´ì§€ì•Šê³ ,

ì´ë²¤íŠ¸ê°€ ë°œìƒ í• ë•Œë§Œ Responseë¥¼ ì´ë²¤íŠ¸ ì •ë³´ì™€ ê°™ì´ ë‹´ì•„ì„œ ë³´ë‚´ëŠ” ë°©ì‹ì´ë‹¤.

ì‹¤ì‹œê°„ì„±ì„ ë³´ì™„í–ˆì§€ë§Œ, ì„œë²„ ì´ë²¤íŠ¸ê°€ ìì£¼ ë°œìƒí•˜ì§€ ì•ŠëŠ” í™˜ê²½ì—ì„œ ì´ìš©í•˜ëŠ”ê²Œ ì¢‹ë‹¤.

ì´ê²ƒ ë˜í•œ ì´ë²¤íŠ¸ê°€ ìì£¼ ë°œìƒí•˜ë©´ ë¹„íš¨ìœ¨ì ì¸ íŠ¸ë ˆí”½ì´ ë°œìƒí•´ ì˜¤íˆë ¤ í´ë§ ë°©ì‹ë³´ë‹¤ ë” ì„œë²„ì— ë¶€ë‹´ì£¼ëŠ” ê²½ìš°ë„ ìˆë‹¤.

ì •ë¦¬í•˜ë©´,

- ì„œë²„ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì¦‰ì‹œ ì‘ë‹µì„ ì£¼ì§€ ì•Šê³  ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ë•Œë§Œ ì¤€ë‹¤.
- ê²½ìš°ì— ë”°ë¼ Long Polling ë°©ì‹ì´ Polling ë°©ì‹ë³´ë‹¤ ì„œë²„ì— ë¶€í•˜ë¥¼ ë” ì£¼ëŠ” ê²½ìš°ë„ ìˆë‹¤ê³  í•œë‹¤.

### Server-sent Events

![image](https://github.com/DongYeopMe/development_note/assets/70151275/44675f01-c4a3-4749-b4a9-bb7aeb7ad558)

Server-sent Events ê¸°ë²•ì€ í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì—†ì´ ì„œë²„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë‹¨ë°©í–¥ìœ¼ë¡œ ì´ë²¤íŠ¸ë¥¼ ì „ì†¡í•˜ëŠ” ê¸°ë²•ì´ë‹¤. ë°©ì‹ì€ ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ ì„œë²„ìª½ íŠ¹ì • ì´ë²¤íŠ¸ë¥¼ êµ¬ë…í•˜ë©´ í•´ë‹¹ ì´ë²¤íŠ¸ ë°œìƒì‹œ ì´ë²¤íŠ¸ë¥¼ ì „ì†¡í•œë‹¤.

í•˜ì§€ë§Œ, í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„œë²„ë¡œ ì´ë²¤íŠ¸ë¥¼ ì „ì†¡í•  ìˆ˜ ì—†ëŠ”ë°©ì‹ì´ë©°, ìµœëŒ€ ë™ì‹œ ì ‘ì† íšŸìˆ˜ê°€ ì œí•œë˜ì–´ìˆë‹¤.

# SSEë¥¼ í†µí•´ í†µì‹  ì—°ê²° ë° ì•Œë¦¼ ê¸°ëŠ¥ êµ¬í˜„

## ì•Œë¦¼ì´ ë°œìƒí•˜ëŠ” ê³¼ì •

ìš°ë¦¬ê°€ ë§Œë“œëŠ” ì„œë¹„ìŠ¤ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê²½ìš°ì— ì´ë²¤íŠ¸(ì•Œë¦¼)ì´ ë°œìƒí•œë‹¤.

- ìœ ì €ê°€ íŒ”ë¡œìš° í–ˆì„ ê²½ìš°
- ì‚¬ìš©ìê°€ ë³¸ì¸ ëŒ“ê¸€ ë˜ëŠ” ê²Œì‹œë¬¼ì— ëŒ“ê¸€ì„ ë‚¨ê¸¸ ê²½ìš°
- ì‚¬ìš©ìê°€ ìœ ì €ë¥¼ íƒœê·¸ í–ˆì„ ê²½ìš°
- ë©”ì‹œì§€ê°€ ì˜¬ê²½ìš°
- ë³¸ì¸ ê²Œì‹œë¬¼ ë˜ëŠ” ëŒ“ê¸€ì— ì¢‹ì•„ìš” ëˆ„ë¥¼ê²½ìš°

## êµ¬í˜„

Spring Framework 4.2ë¶€í„° SSE í†µì‹ ì„ ì§€ì›í•˜ëŠ” SseEmitter í´ë˜ìŠ¤ë¥¼ ì´ìš©í•´ êµ¬í˜„í•˜ê² ìŠµë‹ˆë‹¤.

## êµ¬ë…

**Controller**

```java
@RestController
@RequiredArgsConstructor
public class NotificationController {

		private final AlarmService alarmService;

		@GetMapping("/subscribe/{username}")
		public ResponseEntity<SseEmitter> subscribe(@PathVariable("username") String username) {
		  return new ResponseEntity<>(alarmService.connectSubscribe(username), HttpStatus.OK);
		}
}
```

í´ë¼ì´ì–¸íŠ¸ì—ì„œ êµ¬ë… ìš”ì²­ ë³´ë‚´ê³  SSEEMITTERë¥¼ ë°˜í™˜ì„ ë°›ì•„ì„œ ì—°ê²°ì„í•œë‹¤.

**Service**

```java
@Slf4j
@Service
@RequiredArgsConstructor
public class AlarmService {

	  private final Map<String, SseEmitter> emitters = new ConcurrentHashMap<>();

		@Transactional
    public SseEmitter connectSubscribe(String username) {
        securityUtil.checkLoginMember();
        memberRepository.findByUsername(username)
                .orElseThrow(() -> new BusinessException(MEMBER_NOT_FOUND));
        SseEmitter emitter = new SseEmitter();
        emitters.put(username, emitter);
        emitter.onTimeout(() -> emitters.remove(username));// í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ì‹œê°„ì´ ì´ˆê³¼ë ë•Œ ì‹¤í–‰ ì‘ì—…
        emitter.onCompletion(() -> emitters.remove(username));// ì—°ê²° ì™„ë£Œ ë ëŒ€ ì‹¤í–‰í•  ì‘ì—…
        sendNotification(username, username + "ë‹˜ì˜ í†µì‹  ì—°ê²°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        return emitter;
    }
}
```

connectSubscribe() ì´ ë©”ì†Œë“œëŠ” êµ¬ë… í• ë•Œ ì“°ì´ëŠ” ë©”ì†Œë“œì´ë‹¤.

emitter.onTimeout(() -> emitters.remove(username))
emitter.onCompletion(() -> emitters.remove(username))

ì´ ì‘ì—…ì€ í˜¹ì‹œë‚˜ ì¤‘ë³µ ì—°ê²°ì´ ëì„ë•Œ ì˜¤ë¥˜ë¥¼ ë°©ì§€í•˜ê³ ì ì¶”ê°€í–ˆë‹¤.

Postmanìœ¼ë¡œ ë™ì‘ ì‹œí‚¤ë©´ ì´ë ‡ê²Œ ì—°ê²°ì´ ëœë‹¤.

![image](https://github.com/DongYeopMe/development_note/assets/70151275/a68283ab-9374-4169-98a5-2beaebb74180)

## ì•Œë¦¼

**Service**

```java
@Slf4j
@Service
@RequiredArgsConstructor
public class AlarmService {

	  private final Map<String, SseEmitter> emitters = new ConcurrentHashMap<>();

    public void sendNotification(String username, String message) {
        SseEmitter emitter = emitters.get(username);
        if (emitter != null) {
            try {
                emitter.send(SseEmitter.event().name("notification").data(message));
            } catch (IOException e) {
                emitter.complete();
                emitters.remove(username);
                throw new BusinessException(NOTIFICATION_CONNECTION_ERROR);
            }
        }
    }
}
```

ì´ë ‡ê²Œ íŠ¹ì • ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ë•Œ ê±°ê¸°ì— ë§ëŠ” ë©”ì„¸ì§€ë¥¼ ì¶”ê°€í•´ ì•Œë¦¼ì„ ë³´ë‚´ì£¼ëŠ” ë©”ì†Œë“œë‹¤.

```java
public enum AlarmType {
    FOLLOW("{agent.username}ë‹˜ì´ íšŒì›ë‹˜ì„ íŒ”ë¡œìš°í•˜ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤."),

    LIKE_POST("{agent.username}ë‹˜ì´ íšŒì›ë‹˜ì˜ ì‚¬ì§„ì„ ì¢‹ì•„í•©ë‹ˆë‹¤."),
    MENTION_POST("{agent.username}ë‹˜ì´ ê²Œì‹œë¬¼ì—ì„œ íšŒì›ë‹˜ì„ ì–¸ê¸‰í–ˆìŠµë‹ˆë‹¤: {post.content}"),

    COMMENT("{agent.username}ë‹˜ì´ ëŒ“ê¸€ì„ ë‚¨ê²¼ìŠµë‹ˆë‹¤: {comment.text}"),
    LIKE_COMMENT("{agent.username}ë‹˜ì´ íšŒì›ë‹˜ì˜ ëŒ“ê¸€ì„ ì¢‹ì•„í•©ë‹ˆë‹¤: {comment.text}"),
    MENTION_COMMENT("{agent.username}ë‹˜ì´ ëŒ“ê¸€ì—ì„œ íšŒì›ë‹˜ì„ ì–¸ê¸‰í–ˆìŠµë‹ˆë‹¤: {comment.text}");

    private String messageTemplate;

    public String createAlarmMessage(Alarm alarm) {
        String message = messageTemplate;
        message = message.replace("{agent.username}", alarm.getAgent().getUsername());

        if (message.contains("{post.content}")) {
            message = message.replace("{post.content}", alarm.getPost().getContent());
        }

        if (message.contains("{comment.text}")) {
            message = message.replace("{comment.text}", alarm.getComment().getText());
        }
        return message;
    }
}
```

AlarmTypeì€ ì´ëŸ° í˜•ì‹ìœ¼ë¡œ êµ¬ì„±í•˜ê³ , ìœ ì €,íŠ¹ì • ì´ë²¤íŠ¸ì— ë§ê²Œ ë©”ì„¸ì§€ë¥¼ replaceí•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ê°€ê³µí•´ì„œ ë³´ë‚´ëŠ” í˜•ì‹ì´ë‹¤.

## ì˜ˆì‹œ

ê·¸ë˜ì„œ ê²Œì‹œë¬¼ ì¢‹ì•„ìš” ë¡œì§ì„ ì¡°ë©´

```java
@Transactional
    public void sendPostLikeAlarm(AlarmType type, Member agent, Member target, PostLike post) {
        if (!type.equals(LIKE_POST)) throw new BusinessException(MISMATCHED_ALARM_TYPE);
        final Alarm alarm = Alarm.builder()
                .type(type)
                .agent(agent)
                .target(target)
                .post(post.getPost())
                .build();

        alarmRepository.save(alarm);
        sendNotification(target.getUsername(), alarm.getType().createAlarmMessage(alarm));
    }
```

Alarmì„ ì €ì¥í•˜ê³ createAlarmMessage()ë¥¼ í†µí•´ ë©”ì„¸ì§€ ì²˜ë¦¬í•˜ê³   sendNotification()ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•œë‹¤.

![image](https://github.com/DongYeopMe/development_note/assets/70151275/0b4d09a2-4398-4bf8-b5e2-3e20443232df)
